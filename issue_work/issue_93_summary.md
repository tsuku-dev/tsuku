# Issue 93 Summary

## What Was Implemented

Recipe Writer component that serializes Recipe structs to TOML format with atomic file operations using write-temp-rename pattern. This is the foundational component for the Recipe Builders feature.

## Changes Made
- `internal/recipe/types.go`: Added `ToMap()` method to Step struct for converting Step to flat map representation
- `internal/recipe/writer.go`: New file with `WriteRecipe` function and `recipeForEncoding` helper struct
- `internal/recipe/writer_test.go`: Comprehensive unit tests covering success, round-trip, atomic behavior, and error cases

## Key Decisions
- **Used intermediate `recipeForEncoding` struct**: The Step struct has custom `UnmarshalTOML` that flattens params into a map. For encoding, we needed the reverse - convert Step back to a map. Rather than implementing `MarshalTOML` (which returns bytes that get embedded as strings), we use an intermediate struct where Steps is `[]map[string]interface{}`.
- **Atomic write via temp file in same directory**: Using `os.CreateTemp` in the same directory as the target ensures the final `os.Rename` is atomic (same filesystem). This prevents partial writes from corrupting recipes.

## Trade-offs Accepted
- **TOML output format may differ from hand-written recipes**: The encoder outputs all fields (including empty strings and zero values) rather than omitting them. This is acceptable because the output is still valid and parseable by the loader.

## Test Coverage
- New tests added: 7 test functions covering:
  - Basic write success
  - Round-trip (write then read back)
  - Directory creation
  - Overwrite existing file
  - Atomic behavior (no temp files on success)
  - Error handling (invalid directory)
  - Complex step with When/Params

## Known Limitations
- Empty optional fields are written to TOML (e.g., `description = ""`). This doesn't affect functionality but makes output slightly more verbose than hand-written recipes.
- No support for custom comments in output (TOML encoder doesn't preserve/add comments)

## Future Improvements
- Consider using `toml:",omitempty"` tags if BurntSushi/toml adds support for omitting zero values
- Add option to write provenance comments (e.g., "Generated by tsuku CargoBuilder")
